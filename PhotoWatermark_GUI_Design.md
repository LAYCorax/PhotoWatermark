# PhotoWatermark 桌面应用程序设计文档

## 项目概述

PhotoWatermark 是一个基于 Python 和 PyQt5/PySide6 的 Windows 桌面端照片水印应用程序，提供直观的图形界面用于批量添加文本和图片水印到照片上。

**设计参考**：本项目采用 MaaAssistantArknights 项目的 GUI 设计风格，确保界面的专业性和用户友好性。

## 技术栈

- **UI框架**: PyQt5/PySide6
- **图像处理**: Pillow (PIL)
- **配置管理**: JSON
- **打包工具**: PyInstaller
- **开发语言**: Python 3.8+

## 架构设计

### 项目结构
```
PhotoWatermark/
├── main.py                    # 应用程序入口
├── ui/                        # UI模块
│   ├── __init__.py
│   ├── main_window.py         # 主窗口
│   ├── dialogs/               # 对话框
│   │   ├── __init__.py
│   │   ├── settings_dialog.py # 设置对话框
│   │   └── template_dialog.py # 模板管理对话框
│   └── widgets/               # 自定义控件
│       ├── __init__.py
│       ├── image_list_widget.py    # 图片列表控件
│       ├── preview_widget.py       # 预览控件
│       └── watermark_config_widget.py # 水印配置控件
├── core/                      # 核心逻辑
│   ├── __init__.py
│   ├── image_processor.py     # 图像处理核心
│   ├── watermark_engine.py    # 水印引擎
│   └── template_manager.py    # 模板管理
├── models/                    # 数据模型
│   ├── __init__.py
│   ├── watermark_config.py    # 水印配置模型
│   └── image_info.py          # 图片信息模型
├── utils/                     # 工具函数
│   ├── __init__.py
│   ├── file_utils.py          # 文件操作工具
│   └── config_utils.py        # 配置工具
├── resources/                 # 资源文件
│   ├── icons/                 # 图标
│   ├── styles/                # 样式表
│   └── templates/             # 默认模板
├── config/                    # 配置文件
│   ├── default_config.json    # 默认配置
│   └── user_templates/        # 用户模板
├── build/                     # 构建输出
├── requirements.txt           # 依赖列表
└── README.md                  # 项目说明
```

### 设计模式

1. **MVC架构**: 模型(models)、视图(ui)、控制器(core) 分离
2. **观察者模式**: UI组件监听数据模型变化
3. **工厂模式**: 水印类型工厂，统一创建不同类型的水印
4. **单例模式**: 配置管理器、模板管理器

## 开发迭代计划

### 迭代一：基础框架与文件处理 (Week 1-2)

#### 核心功能
1. **主窗口框架**
   - 基于 MaaAssistantArknights 风格的主窗口布局
   - 左侧图片列表区域
   - 中央预览区域  
   - 右侧配置面板
   - 底部状态栏

2. **文件导入功能**
   - 支持拖拽导入单张/多张图片
   - 文件选择器批量导入
   - 文件夹导入功能
   - 支持 JPEG、PNG、BMP、TIFF 格式
   - PNG 透明通道处理

3. **图片列表管理**
   - 缩略图显示
   - 文件名显示
   - 批量选择/取消选择
   - 移除功能

#### 技术实现
- PyQt5 主窗口设计
- QListWidget 图片列表
- QLabel 预览显示
- 文件拖拽处理
- 多线程缩略图生成

### 迭代二：基础水印功能 (Week 3-4)

#### 核心功能
1. **文本水印**
   - 自定义文本输入
   - 基础字体选择
   - 简单颜色选择
   - 透明度调节
   - 基础位置选择(九宫格)

2. **实时预览**
   - 预览窗口实时更新
   - 支持图片切换预览
   - 基础缩放功能

3. **导出功能**
   - 指定输出文件夹
   - 防止覆盖原图
   - 基础命名规则(原名、添加前缀/后缀)
   - JPEG/PNG 格式选择

#### 技术实现
- Pillow 图像处理
- QGraphicsView 预览控件
- 水印渲染引擎
- 基础配置管理

### 迭代三：高级水印功能 (Week 5-6)

#### 核心功能
1. **文本水印增强**
   - 系统字体枚举
   - 字号、粗体、斜体
   - 完整调色板
   - 阴影和描边效果

2. **图片水印**
   - 本地图片选择
   - PNG 透明通道支持
   - 比例缩放
   - 透明度调节

3. **精确定位**
   - 鼠标拖拽定位
   - 坐标数值输入
   - 水印旋转功能

#### 技术实现
- 高级字体渲染
- 图片水印合成
- 拖拽交互实现
- 旋转变换算法

### 迭代四：配置管理与优化 (Week 7-8)

#### 核心功能
1. **模板系统**
   - 水印设置保存为模板
   - 模板加载和管理
   - 模板导入/导出
   - 默认模板支持

2. **高级导出选项**
   - JPEG 质量调节
   - 图片尺寸调整
   - 批量处理进度显示
   - 错误处理和日志

3. **用户体验优化**
   - 快捷键支持  
   - 记忆用户设置
   - 多语言支持基础
   - 帮助文档

#### 技术实现
- JSON 配置序列化
- 进度条和异步处理
- 本地化框架
- 用户设置持久化

## UI设计规范 (参考 MaaAssistantArknights)

### 布局设计
1. **主窗口布局**
   - 采用经典三栏布局
   - 左侧文件列表 (25%)
   - 中央预览区域 (50%) 
   - 右侧配置面板 (25%)

2. **控件样式**
   - 统一的按钮样式和尺寸
   - 一致的间距和对齐
   - 清晰的层次结构
   - 合理的颜色搭配

3. **用户交互**
   - 响应式设计
   - 快捷键支持
   - 状态反馈
   - 错误提醒

### 配色方案
- **主色调**: 深蓝色 (#2B579A)
- **辅助色**: 灰色系 (#F5F5F5, #E0E0E0)
- **强调色**: 橙色 (#FF6B35)
- **文本色**: 深灰色 (#333333)

### 图标设计
- 采用扁平化设计
- 统一的图标风格
- 适配高DPI显示
- SVG格式支持

## 核心算法设计

### 水印渲染算法
1. **文本水印渲染**
   ```python
   def render_text_watermark(image, config):
       # 字体加载和文本测量
       # 位置计算
       # 透明度处理
       # 特效渲染(阴影、描边)
       # 图像合成
   ```

2. **图片水印渲染**
   ```python
   def render_image_watermark(base_image, watermark_image, config):
       # 水印图片缩放
       # 透明度处理
       # 旋转变换
       # Alpha合成
   ```

### 批量处理策略
- 多线程处理提高效率
- 内存管理优化
- 进度回调机制
- 错误恢复策略

## 性能优化

1. **内存管理**
   - 大图片分块处理
   - 及时释放图像资源
   - 缩略图缓存策略

2. **处理效率**
   - 多线程并行处理
   - 异步UI更新
   - 智能重新渲染

3. **用户体验**
   - 响应式预览
   - 渐进式加载
   - 操作撤销功能

## 测试策略

1. **单元测试**
   - 核心算法测试
   - 配置管理测试
   - 文件处理测试

2. **集成测试**
   - UI交互测试
   - 端到端功能测试
   - 性能测试

3. **用户测试**
   - 可用性测试
   - 兼容性测试
   - 压力测试

## 发布计划

1. **Alpha版本** (Week 2): 基础框架完成
2. **Beta版本** (Week 4): 核心功能完成
3. **RC版本** (Week 6): 高级功能完成
4. **正式版本** (Week 8): 完整功能和优化完成

## 技术要求

### 开发环境
- Python 3.8+
- PyQt5 5.15+ 或 PySide6 6.0+
- Pillow 8.0+
- PyInstaller 4.0+

### 系统要求
- Windows 10 或更高版本
- 内存: 最少 4GB RAM
- 硬盘: 最少 100MB 可用空间
- 显示: 1280x720 或更高分辨率

### 兼容性
- 支持高DPI显示
- 支持多显示器
- 支持触摸屏操作
- 支持键盘快捷键

这个设计文档为 PhotoWatermark 桌面应用程序提供了完整的开发指导，确保项目能够按计划高质量完成。